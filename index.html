<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Online Whiteboard</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #toolbar {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 100;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: #ffffffcc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    #fullscreenBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 100;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    #canvasContainer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: auto;
      background: #f0f0f0;
      z-index: 1;
    }
    canvas {
      background: #fff;
      display: block;
      touch-action: none;
    }
    input[type="range"] {
      width: 100px;
    }
    #imageInput {
      display: none;
    }
  </style>
</head>
<body>

  <div id="toolbar">
    <label>Color: <input type="color" id="colorPicker" value="#000000"></label>
    <label>Size: <input type="range" id="sizePicker" min="1" max="20" value="3"></label>
    <button id="penBtn">Pen</button>
    <button id="highlightBtn">Highlighter</button>
    <button id="eraseBtn">Eraser</button>
    <button id="lassoEraseBtn">Lasso Erase</button>
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
    <select id="shapeTool">
      <option value="none">Free Draw</option>
      <option value="rect-stroke">Rectangle (Stroke)</option>
      <option value="rect-fill">Rectangle (Fill)</option>
      <option value="circle-stroke">Circle (Stroke)</option>
      <option value="circle-fill">Circle (Fill)</option>
      <option value="line">Line</option>
    </select>
    <button id="clearBtn">Clear</button>
    <button onclick="document.getElementById('imageInput').click()">Upload Image or PDF</button>
    <button id="removeFileBtn">Remove File</button>
    <input type="file" id="imageInput" accept="image/*,application/pdf">
    <button id="prevPageBtn" disabled>⬅ Prev Page</button>
    <button id="nextPageBtn" disabled>Next Page ➡</button>
    <span id="pageInfo"></span>
  </div>

  <button id="fullscreenBtn" title="Fullscreen">⛶</button>

  <div id="canvasContainer">
    <canvas id="board"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const sizePicker = document.getElementById('sizePicker');
    const clearBtn = document.getElementById('clearBtn');
    const fileInput = document.getElementById('imageInput');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');
    const canvasContainer = document.getElementById('canvasContainer');
    const penBtn = document.getElementById('penBtn');
    const highlightBtn = document.getElementById('highlightBtn');
    const eraseBtn = document.getElementById('eraseBtn');
    const lassoEraseBtn = document.getElementById('lassoEraseBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const shapeTool = document.getElementById('shapeTool');

    let tool = 'pen';
    let shape = 'none';
    let drawing = false;
    let pdf = null;
    let pdfPageNum = 1;
    let pdfScale = 1.5;
    let lassoPath = [];
    let startX = 0, startY = 0;

    let undoStack = [];
    let redoStack = [];

    function saveState() {
      undoStack.push(canvas.toDataURL());
      redoStack = [];
    }

    function restoreState(stackFrom, stackTo) {
      if (stackFrom.length === 0) return;
      stackTo.push(canvas.toDataURL());
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      img.src = stackFrom.pop();
    }

    undoBtn.onclick = () => restoreState(undoStack, redoStack);
    redoBtn.onclick = () => restoreState(redoStack, undoStack);

    shapeTool.onchange = () => shape = shapeTool.value;

    function resizeCanvas(width, height) {
      canvas.width = width;
      canvas.height = height;
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left + canvasContainer.scrollLeft,
        y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top + canvasContainer.scrollTop
      };
    }

    function startDraw(e) {
      drawing = true;
      const pos = getPos(e);
      startX = pos.x;
      startY = pos.y;

      if (tool === 'lasso') {
        lassoPath = [pos];
      } else if (shape === 'none') {
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        draw(e);
      }
    }

    function endDraw(e) {
      if (!drawing) return;
      drawing = false;
      const pos = getPos(e);

      if (tool === 'lasso') {
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(lassoPath[0].x, lassoPath[0].y);
        for (let p of lassoPath) ctx.lineTo(p.x, p.y);
        ctx.closePath();
        ctx.clip();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.restore();
      } else if (shape !== 'none') {
        ctx.beginPath();
        ctx.lineWidth = sizePicker.value;
        ctx.strokeStyle = ctx.fillStyle = colorPicker.value;
        if (shape.startsWith('rect')) {
          const w = pos.x - startX;
          const h = pos.y - startY;
          shape.endsWith('fill') ? ctx.fillRect(startX, startY, w, h) : ctx.strokeRect(startX, startY, w, h);
        } else if (shape.startsWith('circle')) {
          const r = Math.sqrt(Math.pow(pos.x - startX, 2) + Math.pow(pos.y - startY, 2));
          ctx.arc(startX, startY, r, 0, 2 * Math.PI);
          shape.endsWith('fill') ? ctx.fill() : ctx.stroke();
        } else if (shape === 'line') {
          ctx.moveTo(startX, startY);
          ctx.lineTo(pos.x, pos.y);
          ctx.stroke();
        }
        ctx.closePath();
      }

      saveState();
    }

    function draw(e) {
      if (!drawing || shape !== 'none') return;
      const pos = getPos(e);

      if (tool === 'lasso') {
        lassoPath.push(pos);
        return;
      }

      ctx.lineWidth = sizePicker.value;
      ctx.lineCap = 'round';

      if (tool === 'pen') {
        ctx.globalAlpha = 1.0;
        ctx.strokeStyle = colorPicker.value;
      } else if (tool === 'highlight') {
        ctx.globalAlpha = 0.3;
        ctx.strokeStyle = colorPicker.value;
      } else if (tool === 'eraser') {
        ctx.globalAlpha = 1.0;
        ctx.strokeStyle = '#FFFFFF';
      }

      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('touchmove', draw);

    penBtn.onclick = () => tool = 'pen';
    highlightBtn.onclick = () => tool = 'highlight';
    eraseBtn.onclick = () => tool = 'eraser';
    lassoEraseBtn.onclick = () => tool = 'lasso';

    clearBtn.onclick = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      saveState();
    };

    async function renderPDFPage(num) {
      const page = await pdf.getPage(num);
      const viewport = page.getViewport({ scale: pdfScale });
      resizeCanvas(viewport.width, viewport.height);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      await page.render({ canvasContext: ctx, viewport }).promise;

      pageInfo.textContent = `Page ${pdfPageNum} of ${pdf.numPages}`;
      prevBtn.disabled = num <= 1;
      nextBtn.disabled = num >= pdf.numPages;
    }

    prevBtn.onclick = () => { if (pdfPageNum > 1) renderPDFPage(--pdfPageNum); };
    nextBtn.onclick = () => { if (pdfPageNum < pdf.numPages) renderPDFPage(++pdfPageNum); };

    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);

      if (file.type === 'application/pdf') {
        pdf = await pdfjsLib.getDocument(url).promise;
        renderPDFPage(pdfPageNum = 1);
      } else {
        const img = new Image();
        img.onload = () => {
          resizeCanvas(img.width, img.height);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
        img.src = url;
        pdf = null;
        pageInfo.textContent = '';
        prevBtn.disabled = nextBtn.disabled = true;
      }
    });

    removeFileBtn.onclick = () => {
      pdf = null;
      resizeCanvas(window.innerWidth, window.innerHeight);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pageInfo.textContent = '';
      prevBtn.disabled = nextBtn.disabled = true;
    };

    fullscreenBtn.onclick = () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    };

    window.addEventListener('resize', () => {
      if (!pdf) resizeCanvas(window.innerWidth, window.innerHeight);
    });

    resizeCanvas(window.innerWidth, window.innerHeight);
    saveState();
  </script>
</body>
</html>
